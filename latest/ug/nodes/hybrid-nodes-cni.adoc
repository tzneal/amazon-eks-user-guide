include::../attributes.txt[]

[.topic]
[#hybrid-nodes-cni]
= Configure CNI for hybrid nodes
:info_titleabbrev: Configure CNI

[abstract]
--
Configure the Cilium CNI for hybrid nodes
--

Cilium is the {aws}-supported Container Networking Interface (CNI) for Amazon EKS Hybrid Nodes. You must install a CNI for hybrid nodes to become ready to serve workloads. Hybrid nodes appear with status `Not Ready` until a CNI is running. You can manage the CNI with your choice of tools such as Helm. The instructions on this page cover Cilium lifecycle management (install, upgrade, delete). See <<hybrid-nodes-ingress-cilium>>, <<hybrid-nodes-ingress-cilium-loadbalancer>>, and <<hybrid-nodes-network-policies>> for how to configure Cilium for ingress, load balancing, and network policies.

Cilium is not supported by {aws} when running on nodes in {aws} Cloud. The Amazon VPC CNI is not compatible with hybrid nodes and the VPC CNI is configured with anti-affinity for the `eks.amazonaws.com/compute-type: hybrid` label.

The Calico documentation previously on this page has been moved to the link:https://github.com/aws-samples/eks-hybrid-examples[EKS Hybrid Examples Repository].

[#hybrid-nodes-cilium-version-compatibility]
== Version compatibility

Cilium version `v1.17.x` is supported for EKS Hybrid Nodes for every Kubernetes version supported in Amazon EKS.

See link:eks/latest/userguide/kubernetes-versions.html[Kubernetes version support,type="documentation"] for the Kubernetes versions supported by Amazon EKS. EKS Hybrid Nodes have the same Kubernetes version support as Amazon EKS clusters with cloud nodes.

[#hybrid-nodes-cilium-support]
== Supported capabilities

{aws} maintains builds of Cilium for EKS Hybrid Nodes that are based on the open source link:https://github.com/cilium/cilium[Cilium project]. To receive support from {aws} for Cilium, you must be using the {aws}-maintained Cilium builds and supported Cilium versions.

{aws} provides technical support for the default configurations of the following capabilities of Cilium for use with EKS Hybrid Nodes. If you plan to use functionality outside the scope of {aws} support, it is recommended to obtain alternative commercial support for Cilium or have the in-house expertise to troubleshoot and contribute fixes to the Cilium project.

[%header,cols="2,3"]
|===
|Cilium Feature	
^|Supported by {aws}

|Kubernetes network conformance	
^|Yes

|Core cluster connectivity
^|Yes	

|IP family	
^|IPv4

|Lifecycle Management	
^|Helm

|Networking Mode
^|VXLAN encapsulation

|IP Address Management (IPAM)	
^|Cilium IPAM Cluster Scope

|Network Policy
^|Kubernetes Network Policy

|Border Gateway Protocol (BGP)	
^|Cilium BGP Control Plane

|Kubernetes Ingress
^|Cilium Ingress, Cilium Gateway

|Service LoadBalancer IP Allocation
^|Cilium Load Balancer IPAM

|Service LoadBalancer IP Address Advertisement
^|Cilium BGP Control Plane

|kube-proxy replacement
^|Yes

|===

[#hybrid-nodes-cilium-considerations]
== Cilium considerations

- By default, Cilium is configured to run in overlay / tunnel mode with VXLAN as the link:https://docs.cilium.io/en/stable/network/concepts/routing/#encapsulation[encapsulation method]. This mode has the fewest requirements on the underlying physical network.
- By default, Cilium link:https://docs.cilium.io/en/stable/network/concepts/masquerading/[masquerades] the source IP address of all pod traffic leaving the cluster to the IP address of the node. If you disable masquerading, then your pod CIDRs must be routable on your on-premises network.
- If you are running webhooks on hybrid nodes, your pod CIDRs must be routable on your on-premises network. If your pod CIDRs are not routable on your on-premises network, then it is recommended to run webhooks on cloud nodes in the same cluster. See <<hybrid-nodes-webhooks>> and <<hybrid-nodes-networking>> for more information.
- {aws} recommends using Cilium's built-in BGP functionality to make your pod CIDRs routable on your on-premises network. For more information on how to configure Cilium BGP with hybrid nodes, see <<hybrid-nodes-cilium-bgp>>.
- The default IP Address Management (IPAM) in Cilium is called link:https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/[Cluster Scope], where the Cilium operator allocates IP addresses for each node based on user-configured pod CIDRs.

[#hybrid-nodes-cilium-install]
== Install Cilium on hybrid nodes

=== Prerequisites

. Install Helm in your command-line environment, see <<helm,Setup Helm instructions>>.
. Install the {aws} Cilium Helm repo
+
[source,bash,subs="verbatim,attributes"]
----
helm repo add cilium https://public.ecr.aws/eks/cilium/cilium
----
+
. Update your local Helm repository to make sure that you have the most recent charts.
+
[source,bash]
----
helm repo update cilium
----

=== Procedure

. Create a YAML file called `cilium-values.yaml`. The following example configures Cilium to run only on hybrid nodes by setting affinity for the `eks.amazonaws.com/compute-type: hybrid` label for the Cilium agent and operator.

- Configure `clusterPoolIpv4PodCIDRList` with the same pod CIDRs you configured for your EKS cluster's _remote pod networks_. For example, `10.100.0.0/24`. The Cilium operator allocates IP address slices from within the configured `clusterPoolIpv4PodCIDRList` IP space. Your pod CIDR must not overlap with your on-premises node CIDR, your VPC CIDR, or your Kubernetes service CIDR.
- Configure `clusterPoolIpv4MaskSize` based on your required pods per node. For example, `25` for a /25 segment size of 128 pods per node.
- Do not change `clusterPoolIpv4PodCIDRList` or `clusterPoolIpv4MaskSize` after deploying Cilium on your cluster, see https://docs.cilium.io/en/stable/network/concepts/ipam/cluster-pool/#expanding-the-cluster-pool[Expanding the cluster pool] for more information.
- If you are running Cilium in kube-proxy replacement mode, set `kubeProxyReplacement: "true"` in your Helm values and ensure you do not have an existing kube-proxy deployment running on the same nodes as Cilium.
- The example below disables the Envoy Layer 7 (L7) proxy that Cilium uses for L7 network policies and ingress. For more information, see <<hybrid-nodes-network-policies>> and <<hybrid-nodes-ingress-cilium>>. 
- The example below configures `loadBalancer.serviceTopology`: `true` for Service Traffic Distribution to function correctly if you configure it for your services. For more information, see <<hybrid-nodes-mixed-service-traffic-distribution>>.
- For a full list of Helm values for Cilium, see the https://docs.cilium.io/en/stable/helm-reference/[Helm reference] in the Cilium documentation.
+
[source,bash,subs="verbatim,attributes,quotes"]
----
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
      - matchExpressions:
        - key: eks.amazonaws.com/compute-type
          operator: In
          values:
          - hybrid
ipam:
  mode: cluster-pool
  operator:
    clusterPoolIPv4MaskSize: [.replaceable]`25`
    clusterPoolIPv4PodCIDRList:
    - [.replaceable]`POD_CIDR`
operator:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: eks.amazonaws.com/compute-type
            operator: In
            values:
              - hybrid
  unmanagedPodWatcher:
    restart: false
loadBalancer:
  serviceTopology: true
envoy:
  enabled: false
kubeProxyReplacement: "false"
----

. Install Cilium on your cluster.
- Replace `CILIUM_VERSION` with a Cilium version (for example `1.17.5`). It is recommended to use the latest patch version for the Cilium minor version. You can find the latest patch release available in your local Helm repository with the `helm search repo cilium/cilium --versions` command.
- If you are using a specific kubeconfig file, use the `--kubeconfig` flag with the Helm install command.
+
[source,bash,subs="verbatim,attributes,quotes"]
----
helm install cilium cilium/cilium \
    --version [.replaceable]`CILIUM_VERSION` \
    --namespace kube-system \
    --values cilium-values.yaml
----

. Confirm your Cilium installation was successful with the following commands. You should see the `cilium-operator` deployment and the `cilium-agent` running on each of your hybrid nodes. Additionally, your hybrid nodes should now have status `Ready`. For information on how to configure Cilium BGP to advertise your pod CIDRs to your on-premises network, proceed to <<hybrid-nodes-cilium-bgp>>.
+
[source,bash,subs="verbatim,attributes"]
----
kubectl get pods -n kube-system
----
+
[source,bash,subs="verbatim,attributes"]
----
NAME                              READY   STATUS    RESTARTS   AGE
cilium-jjjn8                      1/1     Running   0          11m
cilium-operator-d4f4d7fcb-sc5xn   1/1     Running   0          11m
----
+
[source,bash,subs="verbatim,attributes"]
----
kubectl get nodes
----
+
[source,bash,subs="verbatim,attributes"]
----
NAME                   STATUS   ROLES    AGE   VERSION
mi-04a2cf999b7112233   Ready    <none>   19m   v1.31.0-eks-a737599
----

[#hybrid-nodes-cilium-upgrade]
== Upgrade Cilium on hybrid nodes

Before upgrading your Cilium deployment, carefully review the https://docs.cilium.io/en/v1.17/operations/upgrade/[Cilium upgrade documentation] and the upgrade notes to understand the changes in the target Cilium version.

. Ensure that you have installed the `helm` CLI on your command-line environment. See the https://helm.sh/docs/intro/quickstart/[Helm documentation] for installation instructions.

. Install the Cilium Helm repo.
+
[source,bash,subs="verbatim,attributes"]
----
helm repo add cilium https://helm.cilium.io/
----
+
. Run the Cilium upgrade pre-flight check. Replace `CILIUM_VERSION` with your target Cilium version. We recommend that you run the latest patch version for your Cilium minor version. You can find the latest patch release for a given minor Cilium release in the https://github.com/cilium/cilium#stable-releases[Stable Releases section] of the Cilium documentation.
+
[source,bash,subs="verbatim,attributes"]
----
helm install cilium-preflight cilium/cilium --version CILIUM_VERSION \
  --namespace=kube-system \
  --set preflight.enabled=true \
  --set agent=false \
  --set operator.enabled=false
----

. After applying the `cilium-preflight.yaml`, ensure that the number of `READY` pods is the same number of Cilium pods running.
+
[source,bash,subs="verbatim,attributes"]
----
kubectl get ds -n kube-system | sed -n '1p;/cilium/p'
----
+
[source,bash,subs="verbatim,attributes"]
----
NAME                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
cilium                    2         2         2       2            2           <none>          1h20m
cilium-pre-flight-check   2         2         2       2            2           <none>          7m15s
----

. Once the number of READY pods are equal, make sure the Cilium pre-flight deployment is also marked as READY 1/1. If it shows READY 0/1, consult the https://docs.cilium.io/en/v1.17/operations/upgrade/#cnp-validation[CNP Validation] section and resolve issues with the deployment before continuing with the upgrade.
+
[source,bash,subs="verbatim,attributes"]
----
kubectl get deployment -n kube-system cilium-pre-flight-check -w
----
+
[source,bash,subs="verbatim,attributes"]
----
NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
cilium-pre-flight-check   1/1     1            0           12s
----

. Delete the preflight
+
[source,bash,subs="verbatim,attributes"]
----
helm uninstall cilium-preflight --namespace kube-system
----
. Before running the `helm upgrade` command, preserve the values for your deployment in a `existing-cilium-values.yaml` or use `--set` command line options for your settings when you run the upgrade command. The upgrade operation overwrites the Cilium ConfigMap, so it is critical that your configuration values are passed when you upgrade. 
+
[source,bash,subs="verbatim,attributes,quotes"]
----
helm get values cilium --namespace kube-system -o yaml > existing-cilium-values.yaml
----
+
. During normal cluster operations, all Cilium components should run the same version. The following steps describe how to upgrade all of the components from one stable release to a later stable release. When upgrading from one minor release to another minor release, it is recommended to upgrade to the latest patch release for the existing Cilium minor version first. To minimize disruption, set the `upgradeCompatibility` option to the initial Cilium version that you installed in this cluster.
+
[source,bash,subs="verbatim,attributes,quotes"]
----
helm upgrade cilium cilium/cilium --version [.replaceable]`CILIUM_VERSION` \
  --namespace kube-system \
  --set upgradeCompatibility=[.replaceable]`1.X` \
  -f existing-cilium-values.yaml
----
+
. (Optional) If you need to rollback your upgrade due to issues, run the following commands.
+
[source,bash,subs="verbatim,attributes"]
----
helm history cilium --namespace kube-system
helm rollback cilium [REVISION] --namespace kube-system
----

[#hybrid-nodes-cilium-delete]
== Delete Cilium from hybrid nodes

. Run the following command to uninstall all Cilium components from your cluster. Note, uninstalling the CNI might impact the health of nodes and pods and shouldn't be performed on production clusters.
+
[source,bash,subs="verbatim,attributes"]
----
helm uninstall cilium --namespace kube-system
----
+
The interfaces and routes configured by Cilium are not removed by default when the CNI is removed from the cluster, see the https://github.com/cilium/cilium/issues/34289[GitHub issue] for more information.

. To clean up the on-disk configuration files and resources, if you are using the standard configuration directories, you can remove the files as shown by the https://github.com/cilium/cilium/blob/main/plugins/cilium-cni/cni-uninstall.sh[`cni-uninstall.sh` script] in the Cilium repository on GitHub.

. To remove the Cilium Custom Resource Definitions (CRDs) from your cluster, you can run the following commands.
+
[source,bash,subs="verbatim,attributes"]
----
kubectl get crds -oname | grep "cilium" | xargs kubectl delete
----
